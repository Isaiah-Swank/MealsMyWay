<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Recipes</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="book-container">
    <!-- Left Container: Create Recipe Form and Selected Recipes -->
    <div class="my-recipes-container">
      <h1>Recipe Creation and Information</h1>

      <!-- Button to toggle the create recipe form -->
      <ion-button expand="full" (click)="toggleCreateRecipe()">
        {{ showCreateRecipe ? 'Hide Recipe Form' : 'Show Recipe Form' }}
      </ion-button>

      <!-- Collapsible Create Recipe Form -->
      <div *ngIf="showCreateRecipe">
        <form (ngSubmit)="submitRecipe()">
          <ion-item>
            <ion-label position="stacked">Author</ion-label>
            <ion-input [(ngModel)]="newRecipe.author" name="author" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Title</ion-label>
            <ion-input [(ngModel)]="newRecipe.title" name="title" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Ingredients</ion-label>
            <ion-textarea [(ngModel)]="newRecipe.ingredients" name="ingredients" required></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Instructions</ion-label>
            <ion-textarea [(ngModel)]="newRecipe.instructions" name="instructions" required></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Tag</ion-label>
            <ion-input [(ngModel)]="newRecipe.tag" name="tag"></ion-input>
          </ion-item>
          <ion-button
            expand="full"
            type="submit"
            [disabled]="!newRecipe.author || !newRecipe.title || !newRecipe.ingredients || !newRecipe.instructions">
            Create Recipe
          </ion-button>
        </form>
      </div>

      <!-- Selected Recipes Section -->
      <ng-container *ngIf="selectedRecipesList.length > 0">
        <h2>Selected Recipes</h2>
        <div *ngFor="let recipe of selectedRecipesList">
          <!-- Recipe Title rendered as a clickable button for toggling details -->
          <ion-button expand="full" (click)="toggleRecipeDetails(recipe)">
            {{ recipe.title }}
            <ion-icon slot="end" *ngIf="!recipe.isExpanded" name="chevron-down-outline"></ion-icon>
            <ion-icon slot="end" *ngIf="recipe.isExpanded" name="chevron-up-outline"></ion-icon>
          </ion-button>

          <!-- Collapsible Recipe Details -->
          <div *ngIf="recipe.isExpanded" class="recipe-details">
            <p><strong>Author:</strong> {{ recipe.author }}</p>
            <p><strong>Ingredients:</strong> {{ recipe.ingredients }}</p>
            <p><strong>Instructions:</strong> {{ recipe.instructions }}</p>
            <p *ngIf="recipe.tag"><strong>Tag:</strong> {{ recipe.tag }}</p>
            <ion-button fill="clear" (click)="toggleRecipeDetails(recipe)">Close</ion-button>
            <ion-button (click)="editRecipe(recipe)">Edit</ion-button>
            <ion-button (click)="deleteRecipe(recipe.id)">Delete</ion-button>
            <!-- Use the removeSelectedRecipe method (or an alias method) to deselect -->
            <ion-button (click)="removeSelectedRecipe(recipe)">Deselect</ion-button>
          </div>
        </div>

        <!-- Add to Calendar Button: Only visible if there are selected recipes -->
        <ion-button expand="full"  (click)="addToCalendar()">
          Add Selected Recipes to Calendar
        </ion-button>
      </ng-container>
    </div>

    <!-- Book Spine (Visual Separator) -->
    <div class="book-spine"></div>

    <!-- Right Container: List of All Recipes (fetched from your database) with Checkboxes -->
    <div class="recipes-container">
      <h1>Choose Recipes</h1>
      <ion-searchbar
        class="search-bar"
        placeholder="Search..."
        (ionInput)="filterRecipes($event)">
      </ion-searchbar>
      <ion-list class="recipe-list">
        <ion-item *ngFor="let recipe of filteredRecipes">
          <ion-checkbox
            slot="start"
            [checked]="isRecipeSelected(recipe)"
            (ionChange)="toggleRecipeSelection(recipe, $event)">
          </ion-checkbox>
          <ion-label>{{ recipe.title }}</ion-label>
        </ion-item>
      </ion-list>
    </div>
  </div>

  <!-- Edit Recipe Modal -->
  <ion-modal cssClass="light-green-modal" [isOpen]="isEditFormOpen" (didDismiss)="closeEditForm()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Edit Recipe</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEditForm()">Cancel</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form (ngSubmit)="updateRecipe()">
          <ion-item>
            <ion-label position="stacked">Title</ion-label>
            <ion-input [(ngModel)]="editRecipeData.title" name="title" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Ingredients</ion-label>
            <ion-textarea [(ngModel)]="editRecipeData.ingredients" name="ingredients" required></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Instructions</ion-label>
            <ion-textarea [(ngModel)]="editRecipeData.instructions" name="instructions" required></ion-textarea>
          </ion-item>
          <ion-item>
            <ion-label position="stacked">Tag</ion-label>
            <ion-input [(ngModel)]="editRecipeData.tag" name="tag"></ion-input>
          </ion-item>
          <ion-button expand="full" type="submit">Update Recipe</ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
